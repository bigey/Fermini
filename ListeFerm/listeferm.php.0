<?php

require_once("../fonctions.php");
require_once("../constantes.php");

session_start();

// verifie si l'autorisation est ok sinon die avec erreur

if (!$_SESSION['auth']==1) {

	header("Location: ../Identification/identification.php");
	exit;

} elseif ( $_POST['annuler'] or $_POST['suivant'] ) { // $_POST est initialisé par un bouton

	if ( isset($_POST['annuler']) ) {
		header("Location: ../Accueil/accueil.php");
		exit;

	} elseif ( isset($_POST['suivant']) and !empty($_POST['ferment']) ) {
		unset($_SESSION['message']);
		$_SESSION['fermentation']['idFermentation'] = $_POST['ferment'];
		header("Location: ../ListeFerm/detail.php");
		exit;

	} else {
// 		echo " *** " . $_POST['annuler'] ." *** " . $_POST['suivant'] . " *** \n";
		$_SESSION['message'] = "ERREUR: vous n'avez sélectionner aucune fermentation !";
		header("Location: {$_SERVER['PHP_SELF']}");
		exit;
	}

} else {  // pas de bouton appuyé

	unset($_SESSION['fermentation']);

	// Ouvre la connexion
	$connection = mysql_connect(SERVEUR, USER, PASS) or die ("Unable to connect database!");

	// Selectionne la base
	mysql_select_db(BASE) or die ("Unable to select database!");

	// Construit les requetes


	$query =	"
				SELECT idFermentation, numMTF, nomLabo, agitateur, ligne, colonne
 				FROM Fermentation AS F, Souche AS S , Poste AS P
				WHERE F.statut='1'
					AND S.idSouche=F.Souche_idSouche
					AND P.idPoste=F.Poste_idPoste
				ORDER BY idFermentation
				";

	// Execute la requete
	$results = mysql_query($query) or die ("Error in query: " . mysql_error());
	$table = mysql_fetch_all($results);
	mysql_free_result($results);



	haut_de_page("Liste des fermentations en cours");

$page = <<<EOF
<h1><a>Liste des fermentations en cours</a></h1>
<form id="form_167188" class="appnitro" method="post" action="">

	<div class="form_description">
		<h2>Liste des fermentations en cours</h2>
		<p>Merci de sélectionner une fermentation dans la liste ci-dessous</p>
		<p class="error">{$_SESSION['message']}</p>
	</div>

	<ul >
		<li>

		<table>
			<thead> <!--entête du tableau-->
				<tr>
					<th>ID</th>
					<th>Temps (h)</th>
					<th>CO2 (g/L)</th>
					<th>VCO2 (g/L/h)</th>
					<th>MTF</th>
					<th>Nom</th>
					<th>Agitateur</th>
					<th>Ligne</th>
					<th>Colonne</th>
					<th></th>
				</tr>
			</thead>

			<tfoot> <!--pied du tableau-->
				<tr>
					<th>ID</th>
					<th>Temps (h)</th>
					<th>CO2 (g/L)</th>
					<th>VCO2 (g/L/h)</th>
					<th>MTF</th>
					<th>Nom</th>
					<th>Agitateur</th>
					<th>Ligne</th>
					<th>Colonne</th>
					<th></th>
				</tr>
			</tfoot>

			<tbody>
EOF;

	echo $page;

	if ( isset($table) ) {

		foreach ($table as $row) {


			$query =	"
					SELECT temps, mCO2, vCO2
					FROM Acquisition
					WHERE Fermentation_idFermentation='{$row['idFermentation']}'
					ORDER BY temps DESC
					LIMIT 1
					";

			// Execute la requete
			$results = mysql_query($query) or die ("Error in query: " . mysql_error());
			$acquis = mysql_fetch_assoc($results);
			mysql_free_result($results);

			$temps	= '';
			$mCO2	= '';
			$vCO2	= '';

			if ( !empty($acquis) ) {
				$temps=number_format($acquis['temps'], 2);
				$mCO2=number_format($acquis['mCO2'], 2);
				$vCO2=number_format($acquis['vCO2'], 3);
			}



			echo "<tr>\n";
			echo "<td>{$row['idFermentation']}</td>\n";
			echo "<td>$temps</td>\n";
			echo "<td>$mCO2</td>\n";
			echo "<td>$vCO2</td>\n";
			echo "<td>{$row['numMTF']}</td>\n";
			echo "<td>{$row['nomLabo']}</td>\n";
			echo "<td>{$row['agitateur']}</td>\n";
			echo "<td>{$row['ligne']}</td>\n";
			echo "<td>{$row['colonne']}</td>\n";
			echo "<td><input id=\"element_1_1\" name=\"ferment\" class=\"element radio\" type=\"radio\" value=\"{$row['idFermentation']}\"/></td>\n";
			echo "</tr>\n";
		}

	} else {

		echo "<tr><td>Aucune fermentation en cours...</td></td>\n";
	}


$page = <<<EOF
			</tbody>
		</table>
		</li>

		<li class="buttons">
			<input type="hidden" name="form_id" value="167188" />
			<input id="saveForm" class="button_text" type="submit" name="suivant" value="Suivant" />
			<input id="saveForm" class="button_text" type="submit" name="annuler" value="Annuler" />
		</li>
	</ul>
</form>
EOF;

	echo $page;
	bas_de_page();

	// Ferme la connexion
	mysql_close($connection);
}

exit;

?>
